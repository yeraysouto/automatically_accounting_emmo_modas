services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: emmo
      POSTGRES_USER: emmo
      POSTGRES_PASSWORD: emmo
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U emmo -d emmo"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - emmo_pgdata:/var/lib/postgresql/data

  migrate:
    build:
      context: .
    environment:
      EMMO_DATABASE_URL: postgresql+psycopg://emmo:emmo@postgres:5432/emmo
      EMMO_DB_AUTO_CREATE: "false"
    depends_on:
      - postgres
    command:
      - sh
      - -c
      - |
        python scripts/wait_for_postgres.py
          alembic upgrade head

volumes:
  emmo_pgdata:
